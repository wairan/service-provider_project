{% extends "base.html" %}

{% block title %}Booking Details - Owner{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="mb-2">Booking Details</h1>
            <p class="text-muted">Manage booking request</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('owner_business.view_bookings') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Bookings
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <div class="col-md-8">
            <!-- Booking Information Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-info-circle"></i> Booking Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Booking ID</p>
                            <p class="mb-3">
                                <code>{{ booking.booking_id }}</code>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Status</p>
                            <p class="mb-3">
                                {% if booking.status == 'requested' %}
                                <span class="badge bg-warning text-dark" style="font-size: 1rem;">Pending</span>
                                {% elif booking.status == 'accepted' %}
                                <span class="badge bg-success" style="font-size: 1rem;">Accepted</span>
                                {% elif booking.status == 'rejected' %}
                                <span class="badge bg-danger" style="font-size: 1rem;">Rejected</span>
                                {% elif booking.status == 'completed' %}
                                <span class="badge bg-info" style="font-size: 1rem;">Completed</span>
                                {% elif booking.status == 'cancelled' %}
                                <span class="badge bg-secondary" style="font-size: 1rem;">Cancelled</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Booking Date & Time</p>
                            <p class="mb-3">
                                <strong>{{ booking.booking_time.strftime('%A, %B %d, %Y at %H:%M') }}</strong>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Duration</p>
                            <p class="mb-3">
                                <strong>{{ booking.duration_minutes }} minutes</strong>
                            </p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Service Price</p>
                            <p class="mb-3">
                                <strong>${{ "%.2f"|format(booking.price) }}</strong>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Request Created</p>
                            <p class="mb-0">
                                <small>{{ booking.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Information -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-person-circle"></i> Customer Information
                    </h5>
                </div>
                <div class="card-body">
                    {% if customer %}
                    <div class="row">
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Name</p>
                            <p class="mb-3"><strong>{{ customer.name }}</strong></p>
                        </div>
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Email</p>
                            <p class="mb-3">
                                <a href="mailto:{{ customer.email }}">{{ customer.email }}</a>
                            </p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Phone</p>
                            <p class="mb-3">
                                <a href="tel:{{ customer.phone }}">{{ customer.phone }}</a>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Location</p>
                            <p class="mb-0">
                                <small>{{ customer.street_house }}, {{ customer.city }}, {{ customer.district }}</small>
                            </p>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted">Customer information not available</p>
                    {% endif %}
                </div>
            </div>

            <!-- Service Information -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-briefcase"></i> Service Information
                    </h5>
                </div>
                <div class="card-body">
                    {% if service %}
                    <p class="text-muted mb-1">Service Name</p>
                    <p class="mb-3"><strong>{{ service.name }}</strong></p>

                    <p class="text-muted mb-1">Description</p>
                    <p class="mb-3">{{ service.description or "No description provided" }}</p>
                    {% else %}
                    <p class="text-muted">Service information not available</p>
                    {% endif %}
                </div>
            </div>

            <!-- Timeline / Status History -->
            {% if booking.timestamps %}
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history"></i> Status Timeline
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% if booking.timestamps.get('requested_at') %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-warning"></div>
                            <div class="timeline-content">
                                <p class="mb-1"><strong>Requested</strong></p>
                                <small class="text-muted">{{ booking.timestamps.get('requested_at') }}</small>
                            </div>
                        </div>
                        {% endif %}

                        {% if booking.timestamps.get('accepted_at') %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <p class="mb-1"><strong>Accepted</strong></p>
                                <small class="text-muted">{{ booking.timestamps.get('accepted_at') }}</small>
                            </div>
                        </div>
                        {% endif %}

                        {% if booking.timestamps.get('rejected_at') %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-danger"></div>
                            <div class="timeline-content">
                                <p class="mb-1"><strong>Rejected</strong></p>
                                <small class="text-muted">{{ booking.timestamps.get('rejected_at') }}</small>
                            </div>
                        </div>
                        {% endif %}

                        {% if booking.timestamps.get('completed_at') %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-info"></div>
                            <div class="timeline-content">
                                <p class="mb-1"><strong>Completed</strong></p>
                                <small class="text-muted">{{ booking.timestamps.get('completed_at') }}</small>
                            </div>
                        </div>
                        {% endif %}

                        {% if booking.timestamps.get('cancelled_at') %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-secondary"></div>
                            <div class="timeline-content">
                                <p class="mb-1"><strong>Cancelled</strong></p>
                                <small class="text-muted">{{ booking.timestamps.get('cancelled_at') }}</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Actions Sidebar -->
        <div class="col-md-4">
            <div class="card border-0 shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning-charge"></i> Actions
                    </h5>
                </div>
                <div class="card-body">
                    {% if booking.status == 'requested' %}
                    <!-- Accept Button -->
                    <button type="button" class="btn btn-success w-100 mb-2" id="acceptBookingBtn"
                        onclick="acceptBooking(event)">
                        <i class="bi bi-check-circle"></i> Accept Booking
                    </button>

                    <!-- Reject Button (Direct) -->
                    <button type="button" class="btn btn-danger w-100 mb-2" id="rejectBookingBtn"
                        onclick="rejectBooking(event)">
                        <i class="bi bi-x-circle"></i> Reject Booking
                    </button>

                    {% elif booking.status == 'accepted' %}
                    <div class="alert alert-success mb-3">
                        <i class="bi bi-check-circle"></i>
                        <strong>Booking Accepted</strong>
                        <p class="mb-0">You accepted this booking. The customer has been notified.</p>
                    </div>
                    <!-- Payment received toggle for owner -->
                    <div class="mb-3">
                        {% if booking.payment_received %}
                        <div class="alert alert-success">
                            <i class="bi bi-cash-stack"></i>
                            <strong>Payment received</strong>
                            <p class="mb-0">Marked received at {{ booking.payment_received_at }}</p>
                        </div>
                        {% else %}
                        <form id="markPaymentForm" method="POST" action="{{ url_for('owner_business.mark_payment_received', booking_id=booking.booking_id) }}">
                            <button type="button" class="btn btn-outline-success w-100 mb-2" id="markPaymentBtn" onclick="markPayment(event)">
                                <i class="bi bi-cash-stack"></i> Mark Payment Received
                            </button>
                        </form>
                        {% endif %}
                    </div>
                    {% elif booking.status == 'rejected' %}
                    <div class="alert alert-danger mb-3">
                        <i class="bi bi-x-circle"></i>
                        <strong>Booking Rejected</strong>
                        <p class="mb-0">You rejected this booking. The customer has been notified.</p>
                    </div>
                    {% elif booking.status == 'completed' %}
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-flag-fill"></i>
                        <strong>Booking Completed</strong>
                        <p class="mb-0">This booking has been marked as completed.</p>
                    </div>
                    {% elif booking.status == 'cancelled' %}
                    <div class="alert alert-secondary mb-3">
                        <i class="bi bi-x-octagon"></i>
                        <strong>Booking Cancelled</strong>
                        <p class="mb-0">This booking has been cancelled.</p>
                    </div>
                    {% endif %}

                    <hr>

                    <p class="text-muted small mb-2">Business:</p>
                    <p class="mb-3">
                        <strong>{{ business.name }}</strong>
                        <br>
                        <small>{{ business.category }}</small>
                    </p>

                    <a href="{{ url_for('owner_business.view_business', business_id=business.business_id) }}"
                        class="btn btn-outline-primary w-100">
                        <i class="bi bi-shop"></i> View Business
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .timeline {
        position: relative;
        padding-left: 20px;
    }

    .timeline-item {
        margin-bottom: 20px;
        position: relative;
    }

    .timeline-marker {
        position: absolute;
        left: -30px;
        top: 5px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 2px solid #fff;
    }

    .timeline-content {
        padding-left: 10px;
    }

    /* Ensure modal is properly displayed and interactive */
    .modal {
        z-index: 1055;
    }

    .modal-backdrop {
        z-index: 1050;
    }

    .modal.show {
        display: block !important;
    }
</style>

<script>
    // Handle accept booking via AJAX
    function acceptBooking(event) {
        event.preventDefault();

        if (!confirm('Are you sure you want to accept this booking?')) {
            return;
        }

        const acceptBtn = document.getElementById('acceptBookingBtn');
        acceptBtn.disabled = true;
        acceptBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Accepting...';

        // Get booking ID from URL
        const bookingId = window.location.pathname.split('/').pop();

        // Send AJAX request
        fetch(`/owner/booking/${bookingId}/accept`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded'
            }
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Failed to accept booking');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show success message and reload
                    alert(data.message);
                    window.location.href = data.redirect_url || '/owner/bookings';
                } else {
                    throw new Error(data.error || 'Unknown error occurred');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error.message);

                // Re-enable button
                acceptBtn.disabled = false;
                acceptBtn.innerHTML = '<i class="bi bi-check-circle"></i> Accept Booking';
            });
    }

    // Handle reject booking via AJAX (Direct)
    function rejectBooking(event) {
        event.preventDefault();

        if (!confirm('Are you sure you want to reject this booking? This action cannot be undone.')) {
            return;
        }

        const rejectBtn = document.getElementById('rejectBookingBtn');
        rejectBtn.disabled = true;
        rejectBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Rejecting...';

        // Get booking ID from URL
        const bookingId = window.location.pathname.split('/').pop();

        // Send AJAX request
        fetch(`/owner/booking/${bookingId}/reject`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded'
            }
        })
            .then(response => {
                if (response.status === 401) {
                    // Unauthorized - redirect to login
                    return response.json().then(data => {
                        alert('Your session has expired. Please log in again.');
                        window.location.href = data.redirect_url || '/auth/login';
                        throw new Error('Session expired');
                    }).catch(() => {
                        // Fallback if JSON parsing fails
                        window.location.href = '/auth/login';
                        throw new Error('Session expired');
                    });
                }

                if (!response.ok) {
                    // Check if response is HTML (unexpected error)
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('text/html')) {
                        throw new Error('Server returned an HTML error. Please check the console or try again later.');
                    }

                    return response.json().then(data => {
                        throw new Error(data.error || 'Failed to reject booking');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show success message and reload
                    alert(data.message);
                    window.location.href = data.redirect_url || '/owner/bookings';
                } else {
                    throw new Error(data.error || 'Unknown error occurred');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (error.message !== 'Session expired') {
                    alert('Error: ' + error.message);
                    // Re-enable button
                    rejectBtn.disabled = false;
                    rejectBtn.innerHTML = '<i class="bi bi-x-circle"></i> Reject Booking';
                }
            });
    }

    // Mark payment received
    function markPayment(event) {
        event.preventDefault();
        if (!confirm('Mark payment as received?')) return;
        const btn = document.getElementById('markPaymentBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Marking...';
        const bookingId = window.location.pathname.split('/').pop();
        fetch(`/owner/booking/${bookingId}/mark-payment`, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                throw new Error(data.error || 'Failed to mark payment');
            }
        })
        .catch(err => {
            alert('Error: ' + err.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-cash-stack"></i> Mark Payment Received';
        });
    }
</script>
{% endblock %}