{% extends "base.html" %}

{% block title %}{{ business.name }} - Owner View{% endblock %}

{% block content %}
<div class="container-fluid mt-5">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="mb-2">{{ business.name }}</h1>
            <p class="text-muted">Category: {{ business.category|title }}</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('owner_business.dashboard') }}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-arrow-left"></i> Back
            </a>
            <a href="{{ url_for('owner_business.view_business', business_id=business.business_id) }}" class="btn btn-primary">
                <i class="bi bi-refresh"></i> Refresh
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Business Details -->
        <div class="col-md-8">
            <!-- Profile Section -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-building"></i> Business Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                                                <div class="col-md-4">
                                                        {% if business.profile_pic_full or business.profile_pic_lazy %}
                                                            <img src="{{ business.profile_pic_lazy or business.profile_pic_full }}"
                                                                 data-src="{{ business.profile_pic_full or business.profile_pic_lazy }}"
                                                                 alt="{{ business.name }}"
                                                                 class="img-fluid rounded lazy-fade initial-blur"
                                                                 style="max-height:250px;object-fit:cover;">
                                                        {% else %}
                                                            <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height:250px;">
                                                                <i class="bi bi-image" style="font-size:3rem;color:#ccc;"></i>
                                                            </div>
                                                        {% endif %}
                                                </div>
                                                <div class="col-md-8">
                            <p class="mb-2">
                                <strong>Email:</strong> <a href="mailto:{{ business.email }}">{{ business.email }}</a>
                            </p>
                            <p class="mb-2">
                                <strong>Phone:</strong> <a href="tel:{{ business.phone }}">{{ business.phone }}</a>
                            </p>
                            <p class="mb-2">
                                <strong>Location:</strong> {{ business.street_house }}, {{ business.city }}, {{ business.district }}
                            </p>
                            <p class="mb-2">
                                <strong>Status:</strong> 
                                {% if business.is_active %}
                                    <span class="badge bg-success">Active</span>
                                {% else %}
                                    <span class="badge bg-danger">Inactive</span>
                                {% endif %}
                            </p>
                            <p class="mb-0">
                                <strong>Created:</strong> {{ business.created_at.strftime('%B %d, %Y') }}
                            </p>
                        </div>
                    </div>

                    {% if business.description %}
                    <div>
                        <h6>Description</h6>
                        <p class="text-muted">{{ business.description }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Gallery Section -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-images"></i> Gallery ({{ business.gallery_urls|length }})
                    </h5>
                    <form class="d-flex" method="POST" action="{{ url_for('owner_business.add_gallery', business_id=business.business_id) }}" enctype="multipart/form-data">
                        <input class="form-control form-control-sm" type="file" name="gallery_pics" multiple required>
                        <button class="btn btn-sm btn-primary ms-2" type="submit">
                            <i class="bi bi-upload"></i> Upload
                        </button>
                    </form>
                </div>
                <div class="card-body">
                    {% if business.gallery_urls %}
                    <div class="row g-3">
                        {% for image_url in business.gallery_urls %}
                        <div class="col-md-4">
                            <div class="position-relative">
                                <img src="{{ image_url }}" alt="Gallery" class="img-fluid rounded" 
                                     style="height: 200px; object-fit: cover;">
                                <form method="POST" action="{{ url_for('owner_business.delete_gallery', business_id=business.business_id) }}" class="position-absolute top-0 end-0 m-2" onsubmit="return confirm('Delete this image?');">
                                    <input type="hidden" name="gallery_url" value="{{ image_url }}">
                                    <button type="submit" class="btn btn-sm btn-danger">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i> No gallery images yet. Upload using the form above.
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Services Section -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list-check"></i> Services ({{ services|length }})
                    </h5>
                    <a href="{{ url_for('business.create_service', business_id=business.business_id) }}" 
                       class="btn btn-sm btn-primary">
                        <i class="bi bi-plus"></i> Add Service
                    </a>
                </div>
                <div class="card-body p-0">
                    {% if services %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Service Name</th>
                                        <th>Price</th>
                                        <th>Duration</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for service in services %}
                                    <tr>
                                        <td>
                                            <strong>{{ service.name }}</strong>
                                            {% if service.description %}
                                            <br><small class="text-muted">{{ service.description[:50] }}...</small>
                                            {% endif %}
                                        </td>
                                        <td>${{ "%.2f"|format(service.price) }}</td>
                                        <td>{{ service.duration_minutes }} min</td>
                                        <td>
                                            {% if service.is_active %}
                                                <span class="badge bg-success">Active</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Inactive</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{{ url_for('business.update_service', service_id=service.service_id) }}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-pencil"></i> Edit
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info m-3 mb-0">
                            <i class="bi bi-info-circle"></i> No services added yet. Service management feature coming soon.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Quick Stats -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bar-chart"></i> Quick Stats
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <p class="text-muted mb-1">Total Services</p>
                        <h3 class="mb-0">{{ services|length }}</h3>
                    </div>
                    <div class="mb-3">
                        <p class="text-muted mb-1">Gallery Images</p>
                        <h3 class="mb-0">{{ business.gallery_urls|length }}</h3>
                    </div>
                    <div>
                        <p class="text-muted mb-1">Created On</p>
                        <small>{% if business.created_at %}{{ business.created_at.strftime('%B %d, %Y') }}{% else %}N/A{% endif %}</small>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning-charge"></i> Actions
                    </h5>
                </div>
                <div class="card-body">
                    <a href="{{ url_for('owner_business.view_bookings') }}" class="btn btn-outline-primary w-100 mb-2">
                        <i class="bi bi-calendar-check"></i> View Bookings
                    </a>
                    <a href="{{ url_for('business.list_services', business_id=business.business_id) }}" 
                       class="btn btn-outline-info w-100 mb-2">
                        <i class="bi bi-list-check"></i> Manage Services
                    </a>
                    <a href="{{ url_for('business.view_business', business_id=business.business_id) }}" 
                       class="btn btn-outline-secondary w-100 mb-2">
                        <i class="bi bi-eye"></i> Public View
                    </a>
                    <button type="button" class="btn btn-outline-danger w-100" 
                            onclick="toggleActiveStatus()">
                        {% if business.is_active %}
                        <i class="bi bi-x-circle"></i> Deactivate
                        {% else %}
                        <i class="bi bi-check-circle"></i> Activate
                        {% endif %}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleActiveStatus() {
    const action = "{{ 'deactivate' if business.is_active else 'activate' }}";
    if (confirm(`Are you sure you want to ${action} this business?`)) {
        const url = "{{ url_for('business.deactivate_business', business_id=business.business_id) }}";
        fetch(url, {
            method: 'POST',
            headers: {
                'Accept': 'application/json'
            }
        }).then(resp => {
            if (resp.redirected) {
                window.location = resp.url;
                return;
            }
            return resp.text();
        }).then(() => {
            // Reload to reflect updated status
            window.location.reload();
        }).catch(err => {
            console.error('Toggle failed', err);
            alert('Failed to toggle business status');
        });
    }
}

// Lazy load progressive images (swap blurred placeholder to full-quality on intersection)
document.addEventListener('DOMContentLoaded', () => {
    const lazyImages = document.querySelectorAll('img.lazy-fade[data-src]');
    // Apply initial blur via class instead of inline Jinja logic (lint friendly)
    lazyImages.forEach(img => {
        if (img.classList.contains('initial-blur')) {
            img.style.filter = 'blur(8px)';
            img.style.transition = 'filter .6s ease';
        }
    });
    const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                const fullSrc = img.getAttribute('data-src');
                if (fullSrc) {
                    const highRes = new Image();
                    highRes.onload = () => {
                        img.src = fullSrc;
                        img.style.filter = 'blur(0)';
                    };
                    highRes.src = fullSrc;
                }
                observer.unobserve(img);
            }
        });
    }, { rootMargin: '100px' });
    lazyImages.forEach(img => observer.observe(img));
});
</script>
{% endblock %}
